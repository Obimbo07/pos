<%= form_for :booking_history, url: admin_booking_histories_path, method: :post, class: "max-w-xl mx-auto p-6 bg-white rounded-lg shadow-md" do |f| %>
  <div class="mb-4">
    <%= f.label :user_name, class: "block text-sm font-medium text-gray-700" %>
    <%= f.text_field :user_name, class: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" %>
  </div>

  <div class="mb-4">
    <%= f.label :phone_number, class: "block text-sm font-medium text-gray-700" %>
    <%= f.text_field :phone_number, class: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" %>
  </div>

  <div class="mb-4">
    <%= f.label :services, class: "block text-sm font-medium text-gray-700 mb-2" %>
    <div class="space-y-2">
      <%= f.collection_check_boxes :service_ids, Service.all, :id, :name do |b| %>
        <div class="flex items-center">
          <%= b.check_box(class: "h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500") %>
          <%= b.label(class: "ml-2 text-sm text-gray-700") %>
          <% service = Service.find(b.value) %>
          <div class="ml-4">
            <%= f.collection_check_boxes :worker_ids, service.workers, :id, :name, {}, { class: "ml-2 text-sm text-gray-500" } %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="mb-4">
    <%= f.label :inventories, class: "block text-sm font-medium text-gray-700 mb-2" %>
    <div class="space-y-2">
      <%= f.collection_check_boxes :inventory_ids, Inventory.all, :id, :name do |b| %>
        <div class="flex items-center">
          <%= b.check_box(class: "h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500") %>
          <%= b.label(class: "ml-2 text-sm text-gray-700") %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="mb-4">
    <%= f.label :is_paid, class: "block text-sm font-medium text-gray-700" %>
    <%= f.check_box :is_paid, class: "h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" %>
  </div>

  <div class="mb-4">
    <%= f.label :payment_method, class: "block text-sm font-medium text-gray-700" %>
    <%= f.select :payment_method, ['Cash', 'Card', 'Mpesa'], { include_blank: true }, class: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" %>
  </div>
  
  <div class="mb-4">
    <h3 class="text-lg font-bold">Total Price: <span id="total-price" class="text-indigo-600">0</span></h3>
  </div>

  <div class="flex justify-end">
    <%= f.submit "Book Service", class: "px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" %>
  </div>
<% end %>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const serviceCheckboxes = document.querySelectorAll('input[name="booking_history[service_ids][]"]');
    const inventoryCheckboxes = document.querySelectorAll('input[name="booking_history[inventory_ids][]"]');
    const totalPriceElement = document.getElementById("total-price");

    function updateTotal() {
      let total = 0;

      serviceCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
          const servicePrice = parseInt(checkbox.dataset.price, 10) || 0;
          total += servicePrice;
        }
      });

      inventoryCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
          const inventoryPrice = parseInt(checkbox.dataset.price, 10) || 0;
          total += inventoryPrice;
        }
      });

      totalPriceElement.textContent = total;
    }

    serviceCheckboxes.forEach(checkbox => {
      checkbox.addEventListener("change", updateTotal);
    });

    inventoryCheckboxes.forEach(checkbox => {
      checkbox.addEventListener("change", updateTotal);
    });

    updateTotal();
  });
</script>
